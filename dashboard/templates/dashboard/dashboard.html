{% extends "base.html" %}
{% load static add_to_qs %}
{% load humanize %}
{% load i18n %}
{% load issues %}

{% block title %}{% translate "Dashboard" %} · {{ site_title }}{% endblock %}

{% block content %}

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-slate-600/50 dark:bg-slate-900/50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
    <div class="relative p-6 border border-slate-300 dark:border-slate-600 w-96 shadow-lg rounded-md bg-white dark:bg-slate-900">
        <div class="text-center m-4">
            <h3 class="text-2xl font-semibold text-slate-800 dark:text-slate-100 mt-3 mb-4">{% translate "Delete Issues" %}</h3>
            <div class="mt-4 mb-6">
                <p class="text-slate-700 dark:text-slate-300">
                    {% translate "Deleting an Issue is a permanent action and cannot be undone. It's typically better to resolve or mute an issue instead of deleting it, as this allows you to keep track of past issues and their resolutions." %}
                </p>
            </div>
            <div class="flex items-center justify-center space-x-4 mb-4">
                <button id="cancelDelete" class="text-cyan-500 dark:text-cyan-300 font-bold">{% translate "Cancel" %}</button>
                <button id="confirmDelete" type="submit" class="font-bold py-2 px-4 rounded-sm bg-red-500 dark:bg-red-700 text-white border-2 border-red-600 dark:border-red-400 hover:bg-red-600 dark:hover:bg-red-800 active:ring-3">{% translate "Delete" %}</button>
            </div>
        </div>
    </div>
</div>

<div class="m-4">

{% if unapplied_issue_ids %}
<div class="bg-red-100 w-full mt-2 mb-2 p-4 border-red-800 border-2">
    {% translate "The chosen action is not applicable to all selected issues. Issues for which it has not been applied have been left with checkboxes checked so that you can try again with another action." %}
</div>
{% endif %}

<h1 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mt-4">{% translate "Dashboard" %}</h1>

      <form action="." method="post" id="issueForm">
      {% csrf_token %}

<!-- Filter bar + actions -->
<div class="flex flex-wrap gap-2 mt-3 items-center">
    <select id="stateFilter" onchange="applyStateFilter()" class="bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md pl-3 pr-8 py-1.5 text-sm focus:border-cyan-500 dark:focus:border-cyan-400 focus:ring-cyan-200 dark:focus:ring-cyan-700">
        {% for value, label in state_filter_choices %}
        <option value="{{ value }}" {% if state_filter == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <select id="dateRangeFilter" onchange="applyFilters()" class="bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md pl-3 pr-8 py-1.5 text-sm focus:border-cyan-500 dark:focus:border-cyan-400 focus:ring-cyan-200 dark:focus:ring-cyan-700">
        {% for value, label in date_range_choices %}
        <option value="{{ value }}" {% if selected_date_range == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <select id="projectFilter" onchange="applyFilters()" class="bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md pl-3 pr-8 py-1.5 text-sm focus:border-cyan-500 dark:focus:border-cyan-400 focus:ring-cyan-200 dark:focus:ring-cyan-700">
        <option value="">{% translate "All Projects" %}</option>
        {% for proj in projects %}
        <option value="{{ proj.id }}" {% if selected_project == proj.id|slugify %}selected{% endif %}>{{ proj.name }}</option>
        {% endfor %}
    </select>

    <select id="teamFilter" onchange="applyFilters()" class="bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md pl-3 pr-8 py-1.5 text-sm focus:border-cyan-500 dark:focus:border-cyan-400 focus:ring-cyan-200 dark:focus:ring-cyan-700">
        <option value="">{% translate "All Teams" %}</option>
        {% for team in teams %}
        <option value="{{ team.id }}" {% if selected_team == team.id|slugify %}selected{% endif %}>{{ team.name }}</option>
        {% endfor %}
    </select>

    <div class="relative">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" /></svg>
        <input type="text" value="{{ q }}" placeholder="{% translate 'Search...' %}" onkeydown="applySearch(event)" class="bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 focus:border-cyan-500 dark:focus:border-cyan-400 focus:ring-cyan-200 dark:focus:ring-cyan-700 rounded-md pl-8 pr-3 py-1.5 text-sm w-44"/>
    </div>

    <!-- Action buttons (hidden until selection) -->
    <div id="js-action-bar" class="ml-auto flex items-center gap-1 opacity-0 pointer-events-none transition-opacity duration-200 text-xs">
                {% if disable_resolve_buttons %}
                    <button disabled class="font-semibold text-slate-300 dark:text-slate-600 border border-slate-300 dark:border-slate-600 px-3.5 py-1.5 rounded-md" name="action" value="resolve">{% translate "Resolve" %}</button>
                {% else %}
                    <button class="font-semibold text-slate-800 dark:text-slate-100 border border-slate-500 dark:border-slate-400 px-3.5 py-1.5 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 active:ring-3 rounded-md" name="action" value="resolve">{% translate "Resolve" %}</button>
                {% endif %}

                {% spaceless %}
                {% if not disable_mute_buttons %}
                <button name="action" value="mute" class="font-semibold text-slate-500 dark:text-slate-300 border border-slate-300 dark:border-slate-600 px-3.5 py-1.5 hover:bg-slate-200 dark:hover:bg-slate-700 active:ring-3 rounded-s-md">{% translate "Mute" %}</button>
                {% else %}
                <button disabled name="action" value="mute" class="font-semibold text-slate-300 dark:text-slate-600 border border-slate-300 dark:border-slate-600 px-3.5 py-1.5 rounded-s-md">{% translate "Mute" %}</button>
                {% endif %}

                <div class="dropdown">
                    {% if not disable_mute_buttons %}
                        <button disabled class="font-semibold text-slate-500 dark:text-slate-300 fill-slate-500 dark:fill-slate-500 border-slate-300 dark:border-slate-600 px-2 py-1.5 border-r border-b border-t hover:bg-slate-200 dark:hover:bg-slate-700 active:ring-3"><svg xmlns="http://www.w3.org/2000/svg" fill="full" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline"><path d="M6.5,8.5l6,7l6-7H6.5z"/></svg></button>

                        <div class="dropdown-content-right flex-col">
                            {% for mute_option in mute_options %}
                                <button name="action" value="mute_{{ mute_option.for_or_until }}:{{ mute_option.period_name }},{{ mute_option.nr_of_periods }},{{ mute_option.gte_threshold }}" class="block self-stretch font-semibold text-slate-500 dark:text-slate-300 border-slate-300 px-3 py-1.5 border-l border-r border-b bg-white dark:bg-slate-900 hover:bg-slate-200 dark:hover:bg-slate-800 active:ring-3 text-left whitespace-nowrap text-xs">{% if mute_option.for_or_until == "for" %}{{ mute_option.nr_of_periods }} {{ mute_option.period_name }}{% if mute_option.nr_of_periods != 1 %}s{% endif %}{% else %}{{ mute_option.gte_threshold }} events per {% if mute_option.nr_of_periods != 1%} {{ mute_option.nr_of_periods }} {{ mute_option.period_name }}s{% else %} {{ mute_option.period_name }}{% endif %}{% endif %}</button>
                            {% endfor %}
                        </div>
                    {% else %}
                        <button disabled class="font-semibold text-slate-300 dark:text-slate-600 fill-slate-300 dark:fill-slate-600 border-slate-300 dark:border-slate-600 px-2 py-1.5 border-r border-b border-t"><svg xmlns="http://www.w3.org/2000/svg" fill="full" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline"><path d="M6.5,8.5l6,7l6-7H6.5z"/></svg></button>
                    {% endif %}
                </div>

                {% if not disable_unmute_buttons %}
                    <button class="font-semibold text-slate-500 dark:text-slate-300 border-slate-300 dark:border-slate-600 px-3.5 py-1.5 border-r border-b border-t hover:bg-slate-200 dark:hover:bg-slate-700 active:ring-3 rounded-e-md" name="action" value="unmute">{% translate "Unmute" %}</button>
                {% else %}
                    <button disabled class="font-semibold text-slate-300 dark:text-slate-600 border-slate-300 dark:border-slate-600 px-3.5 py-1.5 border-r border-b border-t rounded-e-md" name="action" value="unmute">{% translate "Unmute" %}</button>
                {% endif %}

                <div class="dropdown">
                    <button disabled class="font-semibold text-slate-500 fill-slate-500 border border-slate-300 ml-1 px-2.5 py-1.5 hover:bg-slate-200 active:ring-3 rounded-md">...</button>
                    <div class="dropdown-content-right flex-col">
                        <button type="button" onclick="showDeleteConfirmation()" class="block self-stretch font-semibold text-red-500 dark:text-slate-300 border-slate-300 px-3 py-1.5 border-l border-r border-b bg-white dark:bg-slate-900 hover:bg-red-50 dark:hover:bg-red-800 active:ring-3 text-left whitespace-nowrap text-xs">{% translate "Delete" %}</button>
                    </div>
                </div>
                {% endspaceless %}
    </div>
</div>

      <!-- Table container -->
      <div class="border border-slate-200 dark:border-slate-700 rounded-lg mt-3 overflow-hidden">

      <!-- Column headers -->
      <div class="flex items-center px-3 py-2 text-xs font-medium text-slate-400 dark:text-slate-500 uppercase tracking-wider bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-700">
          <div class="w-9 shrink-0">
              <div class="rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer inline-flex items-center justify-center" onclick="toggleContainedCheckbox(this); matchIssueCheckboxesStateToMain(this)">
                  {% if page_obj.object_list|length > 0 %}<input type="checkbox" class="dark:bg-slate-900 checked:dark:bg-cyan-500 border-cyan-800 dark:border-cyan-400 text-cyan-500 dark:text-cyan-300 focus:ring-cyan-200 dark:focus:ring-cyan-700 cursor-pointer js-main-checkbox w-4 h-4" onclick="event.stopPropagation(); matchIssueCheckboxesStateToMain(this.parentNode)"/>{% endif %}
              </div>
          </div>
          <div class="flex-1">{% translate "Issue" %}</div>
          <div class="hidden sm:block w-28 text-right">{% translate "Last Seen" %}</div>
          <div class="hidden sm:block w-24 text-right">{% translate "Age" %}</div>
          <div class="hidden sm:block w-20 text-right pr-2">{% translate "Events" %}</div>
      </div>

      <!-- Issue rows -->
            {% for issue in page_obj %}
            <div class="flex items-center px-3 py-2.5 border-b border-slate-100 dark:border-slate-700/50 hover:bg-slate-50 dark:hover:bg-slate-800/50 group last:border-b-0">
                <div class="w-9 shrink-0">
                    <div class="rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer inline-flex items-center justify-center" onclick="toggleContainedCheckbox(this); matchMainCheckboxStateToIssueCheckboxes()">
                        <input type="checkbox" {% if issue.id in unapplied_issue_ids %}checked{% endif %} name="issue_ids[]" value="{{ issue.id }}" class="dark:bg-slate-900 checked:dark:bg-cyan-500 border-cyan-800 dark:border-cyan-400 text-cyan-500 dark:text-cyan-300 focus:ring-cyan-200 dark:focus:ring-cyan-700 cursor-pointer js-issue-checkbox w-4 h-4" onclick="event.stopPropagation(); matchMainCheckboxStateToIssueCheckboxes()"/>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <div>
                        <a href="{{ script_prefix }}/issues/issue/{{ issue.id }}/event/last/" class="text-cyan-700 dark:text-cyan-300 font-semibold text-base hover:underline {% if issue.is_resolved %}italic{% endif %}">{% if issue.is_resolved %}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 inline"><path fill-rule="evenodd" d="M12.416 3.376a.75.75 0 0 1 .208 1.04l-5 7.5a.75.75 0 0 1-1.154.114l-3-3a.75.75 0 0 1 1.06-1.06l2.353 2.353 4.493-6.74a.75.75 0 0 1 1.04-.207Z" clip-rule="evenodd" /></svg>{% endif %}{% if issue.is_muted %}<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6 4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" /></svg> {% endif %}{{ issue.title|truncatechars:100 }}</a>
                    </div>
                    <div class="text-xs text-slate-400 dark:text-slate-500 mt-0.5 truncate">
                        {% if issue.last_frame_filename or issue.last_frame_function %}<span>{{ issue.last_frame_filename }}{% if issue.last_frame_function %} in <b>{{ issue.last_frame_function }}</b>{% endif %}</span>{% endif %}
                        <span class="inline-block bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300 text-xs font-semibold px-1.5 py-0 rounded-full ml-1">{{ issue.project.name }}</span>
                    </div>
                </div>
                <div class="hidden sm:block w-28 text-right text-xs text-slate-500 dark:text-slate-400" title="{{ issue.last_seen|date:'N j, Y, P' }}">{{ issue.last_seen|shorttimesince }} ago</div>
                <div class="hidden sm:block w-24 text-right text-xs text-slate-500 dark:text-slate-400" title="{{ issue.first_seen|date:'N j, Y, P' }}">{{ issue.first_seen|shorttimesince }}</div>
                <div class="hidden sm:block w-20 text-right text-xs text-slate-500 dark:text-slate-400 pr-2">{{ issue.digested_event_count|intcomma }}</div>
            </div>
            {% empty %}
            <div class="py-8 text-center">
                <div class="text-lg font-semibold text-slate-400 dark:text-slate-500">
                {% if q %}
                    No {{ state_filter }} issues found for "{{ q }}"
                {% else %}
                    {% if state_filter == "open" %}
                        {% translate "Congratulations! You have no open issues." %}
                    {% else %}
                    {% blocktranslate %}No {{ state_filter }} issues found.{% endblocktranslate %}
                    {% endif %}
                {% endif %}
                </div>
            </div>
            {% endfor %}

      </div>{# end table container #}

        </form>

    <div class="flex items-center mt-3 text-xs text-slate-500 dark:text-slate-400">

        <div class="flex items-center gap-0.5">
                {% if page_obj.has_previous %}
                <a href="?{% add_to_qs page=1 %}" class="inline-flex p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700" title="First page">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M3.22 7.595a.75.75 0 0 0 0 1.06l3.25 3.25a.75.75 0 0 0 1.06-1.06l-2.72-2.72 2.72-2.72a.75.75 0 0 0-1.06-1.06l-3.25 3.25Zm8.25-3.25-3.25 3.25a.75.75 0 0 0 0 1.06l3.25 3.25a.75.75 0 1 0 1.06-1.06l-2.72-2.72 2.72-2.72a.75.75 0 0 0-1.06-1.06Z" clip-rule="evenodd" /></svg></a>

                <a href="?{% add_to_qs page=page_obj.previous_page_number %}" class="inline-flex p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700" title="Previous page">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M9.78 4.22a.75.75 0 0 1 0 1.06L7.06 8l2.72 2.72a.75.75 0 1 1-1.06 1.06L5.47 8.53a.75.75 0 0 1 0-1.06l3.25-3.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" /></svg></a>
                {% else %}
                <span class="inline-flex p-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 text-slate-200 dark:text-slate-600"><path fill-rule="evenodd" d="M3.22 7.595a.75.75 0 0 0 0 1.06l3.25 3.25a.75.75 0 0 0 1.06-1.06l-2.72-2.72 2.72-2.72a.75.75 0 0 0-1.06-1.06l-3.25 3.25Zm8.25-3.25-3.25 3.25a.75.75 0 0 0 0 1.06l3.25 3.25a.75.75 0 1 0 1.06-1.06l-2.72-2.72 2.72-2.72a.75.75 0 0 0-1.06-1.06Z" clip-rule="evenodd" /></svg></span>
                <span class="inline-flex p-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 text-slate-200 dark:text-slate-600"><path fill-rule="evenodd" d="M9.78 4.22a.75.75 0 0 1 0 1.06L7.06 8l2.72 2.72a.75.75 0 1 1-1.06 1.06L5.47 8.53a.75.75 0 0 1 0-1.06l3.25-3.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" /></svg></span>
                {% endif %}

                {% if page_obj.object_list|length > 0 %}
                <span class="px-1">{% translate "Issues" %} {{ page_obj.start_index|intcomma }} – {{ page_obj.end_index|intcomma }}</span>
                {% else %}
                    {% if page_obj.number > 1 %}
                    <span class="px-1">Less than {{ page_obj.start_index }} Issues</span>
                    {% else %}
                    <span class="px-1">0 {% translate "Issues" %}</span>
                    {% endif %}
                {% endif %}

                {% if page_obj.has_next %}
                <a href="?{% add_to_qs page=page_obj.next_page_number %}" class="inline-flex p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700" title="Next page">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M6.22 4.22a.75.75 0 0 1 1.06 0l3.25 3.25a.75.75 0 0 1 0 1.06l-3.25 3.25a.75.75 0 0 1-1.06-1.06L8.94 8 6.22 5.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg></a>
                {% else %}
                <span class="inline-flex p-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 text-slate-200 dark:text-slate-600"><path fill-rule="evenodd" d="M6.22 4.22a.75.75 0 0 1 1.06 0l3.25 3.25a.75.75 0 0 1 0 1.06l-3.25 3.25a.75.75 0 0 1-1.06-1.06L8.94 8 6.22 5.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg></span>
                {% endif %}
        </div>

    </div>

</div>

{% endblock %}

{% block extra_js %}

<script>
    const confirmationBox = document.getElementById('deleteModal');
    const confirmDelete = document.getElementById('confirmDelete');
    const cancelDelete = document.getElementById('cancelDelete');
    const form = document.getElementById('issueForm');
    let actionInput = null;

    function showDeleteConfirmation() { confirmationBox.style.display = 'flex'; }
    cancelDelete.addEventListener('click', () => { confirmationBox.style.display = 'none'; });
    confirmDelete.addEventListener('click', () => {
        if (!actionInput) { actionInput = document.createElement('input'); actionInput.type = 'hidden'; actionInput.name = 'action'; actionInput.value = 'delete'; form.appendChild(actionInput); }
        form.submit();
    });

    var stateUrlMap = {
        {% for key, url in state_url_map.items %}"{{ key }}": "{{ url }}"{% if not forloop.last %}, {% endif %}{% endfor %}
    };
    function applyStateFilter() {
        var state = document.getElementById("stateFilter").value;
        var basePath = stateUrlMap[state] || stateUrlMap["open"];
        var params = new URLSearchParams(window.location.search);
        params.delete("page");
        var qs = params.toString();
        window.location.href = basePath + (qs ? "?" + qs : "");
    }
</script>
    <script src="{% static 'js/issue_list.js' %}"></script>
    <script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}
