{% extends "issues/base.html" %}
{% load static %}
{% load stricter_templates %}
{% load issues %}
{% load humanize %}
{% load i18n %}

{% block tab_content %}

{% if not exceptions %}
    <div class="mt-6 mb-6 italic">
        {% translate "No stacktrace available for this event." %}
    </div>
{% endif %}


{% for exception in exceptions %}

    <div class="flex items-start flex-col-reverse lg:flex-row">
        <div class="overflow-hidden">
            <h1 class="text-2xl font-bold {% if forloop.counter0 > 0 %}mt-4{% endif %} text-ellipsis whitespace-nowrap overflow-hidden">{{ exception.type }}</h1>
            <div class="text-lg mb-4 text-ellipsis whitespace-nowrap overflow-hidden">{{ exception.value }}</div>
        </div>
        {% if forloop.counter0 == 0 %}
        <div class="ml-auto flex flex-none pb-4 lg:pb-0">
            <button class="text-sm text-slate-500 dark:text-slate-300 border-slate-300 dark:border-slate-600 px-2.5 py-1 mr-1 border rounded-md hover:bg-slate-100 dark:hover:bg-slate-800 active:ring-3" onclick="showAllFrames()">Show all</button>
            <button class="text-sm text-slate-500 dark:text-slate-300 border-slate-300 dark:border-slate-600 px-2.5 py-1 mr-1 border rounded-md hover:bg-slate-100 dark:hover:bg-slate-800 active:ring-3" onclick="showInAppFrames()">Show in-app</button>
            <button class="text-sm text-slate-500 dark:text-slate-300 border-slate-300 dark:border-slate-600 px-2.5 py-1 mr-1 border rounded-md hover:bg-slate-100 dark:hover:bg-slate-800 active:ring-3" onclick="showRaisingFrame()">Show raise</button>
            <button class="text-sm text-slate-500 dark:text-slate-300 border-slate-300 dark:border-slate-600 px-2.5 py-1 mr-1 border rounded-md hover:bg-slate-100 dark:hover:bg-slate-800 active:ring-3" onclick="hideAllFrames()">Collapse all</button>
        </div>
        {% endif %}
    </div>

    {% for frame in exception.stacktrace.frames %}
        {% with frame=frame|pygmentize:event.platform %}

        <div class="w-full font-mono text-sm {% if not forloop.first %}mt-px{% endif %}"> {# per frame div #}
            {% if frame.raise_point %}<span id="raise"></span>{% endif %}
            {% if frame.in_app %}<span id="in-app"></span>{% endif %}
            {% if forloop.first and forloop.parentloop.first %}<span id="first-frame"></span>{% endif %}

            <div class="flex items-center px-4 py-2 border border-slate-200 dark:border-slate-700 {% if frame.in_app %}bg-white dark:bg-slate-800{% else %}bg-slate-50 dark:bg-slate-800/50{% endif %} {% if forloop.first %}rounded-t-md{% endif %} {% if forloop.last %}rounded-b-md{% endif %} cursor-pointer" onclick="toggleFrameVisibility(this)"> {# per frame header div #}

                <div class="flex-1 text-ellipsis overflow-hidden"> {# filename, function, lineno #}
                    {% if frame.in_app %}
                        <span class="font-semibold text-slate-800 dark:text-slate-100">{{ frame.filename }}</span>{% if frame.function %} <span class="text-slate-400 dark:text-slate-500">in</span> <span class="font-semibold text-cyan-700 dark:text-cyan-300">{{ frame.function }}</span>{% endif %}{% if frame.lineno %} <span class="text-slate-400 dark:text-slate-500">at line</span> <span class="font-semibold text-slate-800 dark:text-slate-100">{{ frame.lineno }}</span>{% endif %}{% if frame.instruction_addr %} <span class="text-slate-400">{{ frame.instruction_addr }}</span>{% endif %}
                    {% else %}
                        <span class="text-slate-500 dark:text-slate-400">{{ frame.filename }}{% if frame.function %} in {{ frame.function }}{% endif %}{% if frame.lineno%} at line {{ frame.lineno }}{% endif %}{% if frame.instruction_addr %} {{ frame.instruction_addr }}{% endif %}</span>
                    {% endif %}
                </div>

                <div class="ml-auto flex items-center gap-2 shrink-0">{# indicator + chevron #}
                    {% if stack_of_plates and forloop.first or not stack_of_plates and forloop.last %}
                        {% if stack_of_plates and forloop.parentloop.first or not stack_of_plates and forloop.parentloop.last %}
                            <span class="bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 text-xs font-semibold px-2 py-0.5 rounded-full whitespace-nowrap">raise {{ exception.type }}</span>
                        {% else %}
                            <span class="bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 text-xs font-semibold px-2 py-0.5 rounded-full whitespace-nowrap">raise {{ exception.type }} (handled)</span>
                        {% endif %}
                    {% elif stack_of_plates and forloop.last or not stack_of_plates and forloop.first %} {# strictly speaking, not actually "else", but to avoid clutter we hide 'outermost' info when this is also the raise-point #}
                        {% if stack_of_plates and forloop.parentloop.first or not stack_of_plates and forloop.parentloop.last %}
                            <span class="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-semibold px-2 py-0.5 rounded-full whitespace-nowrap">→ begin</span>
                        {% else %}
                            {% comment %}I find it (quite too) hard to come up with a good name for this type of frame that is both short and clear. Thoughts so fare were:
                            * try...
                            * start try
                            * start failing try (handled)
                            * "begin handled" ()
                            * "begin handled" {{ exception.type }}
                            * "outermost handled"
                            * "divergence w/ main exception"
                            * first unique frame
                            {% endcomment %}
                            <span class="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-semibold px-2 py-0.5 rounded-full whitespace-nowrap">try…</span>
                        {% endif %}

                    {% endif %}

                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-slate-400 dark:text-slate-500 js-chevron transition-all {% if frame.raise_point %}rotate-180{% endif %}">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div> {# per frame header div #}

            <div class="js-frame-details {% if frame.in_app %}js-in-app{% endif %} overflow-hidden transition-all {% if stack_of_plates and forloop.parentloop.first and forloop.first or not stack_of_plates and forloop.parentloop.last and forloop.last %}js-raising-frame{% endif %}"
                {% if not frame.raise_point %}data-collapsed="true" style="height: 0px"{% endif %}> {# collapsable part #}

                <div class="border-x border-slate-200 dark:border-slate-700 {% if forloop.last %}border-b rounded-b-md{% endif %}">{# convience div for border #}
                    {% if "context_line" in frame and frame.context_line is not None %}
                    <div class="syntax-coloring bg-slate-50 dark:bg-slate-900">{# code listing #}
                        {# the spread-out pX-6 in this code is intentional to ensure the padding is visible when scrolling to the right, and not visible when scrolling is possible (i.e. the text is cut-off awkwardly to hint at scrolling #}
                        <ol class="list-decimal overflow-x-auto list-inside py-4 {% if frame|firstlineno is None %}list-none{% endif %}" start="{{ frame|firstlineno }}">
                        {% for line in frame.pre_context %}<li class="pl-6 leading-6 text-slate-500 dark:text-slate-400"><div class="whitespace-pre w-full inline pr-6">{{ line }} {# leave space to avoid collapse #}</div></li>{% endfor %}
                        {# the gradient is a workaround, because I can't get a full-width elem going here inside the overflow #}
                        {# when some other line is overflowing. Using the gradient hides this fact (it happens to also look good) #}
                        <li class="pl-6 leading-6 bg-red-50 dark:bg-red-950/30 border-l-2 border-red-400 dark:border-red-500 font-semibold text-slate-800 dark:text-slate-100 w-full"><div class="whitespace-pre w-full inline pr-6">{{ frame.context_line }} {# leave space to avoid collapse #}</div></li>
                        {% for line in frame.post_context %}<li class="pl-6 leading-6 text-slate-500 dark:text-slate-400"><div class="whitespace-pre w-full inline pr-6">{{ line }} {# leave space to avoid collapse #}</div></li>{% endfor %}
                        </ol>
                    </div>
                    {% endif %}

                    {% if frame.vars %}
                    <div class="border-t border-slate-200 dark:border-slate-700">{# variables #}
                        <div class="flex bg-slate-50 dark:bg-slate-800/50 text-xs font-medium text-slate-400 dark:text-slate-500 uppercase tracking-wider">
                            <div class="w-1/3 px-4 py-1.5">{% translate "Variable" %}</div>
                            <div class="w-2/3 px-4 py-1.5">{% translate "Value" %}</div>
                        </div>
                        {% for var, value in frame.vars|items %}
                        <div class="flex border-t border-slate-100 dark:border-slate-700/50 hover:bg-slate-50 dark:hover:bg-slate-800/30">
                            <div class="w-1/3 px-4 py-1 text-slate-600 dark:text-slate-300">{{ var }}</div>
                            <div class="w-2/3 px-4 py-1 text-slate-500 dark:text-slate-400 break-all">{{ value|format_var }}</div>
                        </div>
                        {% endfor %}
                        {% if frame.vars|incomplete %}
                        <div class="flex border-t border-slate-100 dark:border-slate-700/50">
                            <div class="w-1/3 px-4 py-1 italic text-slate-400 dark:text-slate-500">&lt;{{ frame.vars.incomplete }} items trimmed…&gt;</div>
                            <div class="w-2/3 px-4 py-1"></div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if "context_line" not in frame or frame.context_line is None %}{% if not frame.vars %}{# nested ifs as a subsitute for brackets-in-templates #}
                    <div class="px-4 py-6 italic text-slate-400 dark:text-slate-500">
                        {% if frame.debug_id %}{# only in the no-vars-either case to avoid excessive if-nesting (at the cost of completeness, but "will yes-vars, broken debug_id even be a case? For now we hope not) #}
                            No sourcemaps found for Debug ID {{ frame.debug_id }}
                        {% else %}
                            No code context or variables available for this frame.
                        {% endif %}
                    </div>
                    {% endif %}{% endif %}

                </div>

            </div> {# collapsable part #}

        </div> {# per frame div #}

        {% endwith %}
    {% endfor %} {# frame #}
    {# </div> #} {# per-exception div in the multi-exception case #}

    {% if not forloop.last %}
        {% if not stack_of_plates %}
            <div class="italic pt-4">During handling of the above exception another exception occurred or was intentionally reraised:</div>
            {# note: the above is specific to Python. We cannot distinguish between Python's 2 types of chained exceptions because the info is not sent by the client #}
            {# we could try to infer this from the stacktrace, but parsing potentially arbitrarily formatted partial code is brittle #}
        {% else %}
            <div class="italic pt-4">The above exception was caused by or intentially reraised during the handling of the following exception:</div>
        {% endif %}
    {% endif %}

{% endfor %} {# for exception in exceptions #}

{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/issue_stacktrace.js' %}"></script>
{% endblock %}
